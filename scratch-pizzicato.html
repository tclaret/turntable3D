<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scratch avec Pizzicato.js - Synchronisation Ultra-Fine</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzicato/0.6.4/Pizzicato.min.js"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1a1a 100%);
            color: #00ff00;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        h1 {
            color: #e74c3c;
            text-shadow: 0 0 20px rgba(231, 76, 60, 0.5);
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #3498db;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        #vinyl-container {
            position: relative;
            width: 400px;
            height: 400px;
            margin: 30px 0;
        }
        
        #vinyl {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, 
                #333 0%, 
                #1a1a1a 30%, 
                #000 60%, 
                #0a0a0a 100%);
            box-shadow: 
                0 0 40px rgba(231, 76, 60, 0.3),
                inset 0 0 100px rgba(0, 0, 0, 0.5);
            cursor: grab;
            transition: filter 0.2s, box-shadow 0.2s;
            position: relative;
        }
        
        #vinyl.scratching {
            cursor: grabbing;
            filter: brightness(1.3);
            box-shadow: 
                0 0 60px rgba(231, 76, 60, 0.8),
                inset 0 0 100px rgba(0, 0, 0, 0.5);
        }
        
        /* Sillons du vinyl */
        #vinyl::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 90%;
            border-radius: 50%;
            background: repeating-radial-gradient(
                circle at 50% 50%,
                transparent 0px,
                transparent 2px,
                rgba(255, 255, 255, 0.03) 2px,
                rgba(255, 255, 255, 0.03) 3px
            );
        }
        
        /* Centre du vinyl */
        #vinyl::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle, #e74c3c 0%, #c0392b 50%, #1a1a1a 100%);
            box-shadow: 
                0 0 20px rgba(231, 76, 60, 0.5),
                inset 0 0 15px rgba(0, 0, 0, 0.8);
        }
        
        /* Marque de rÃ©fÃ©rence */
        .reference-mark {
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 30px;
            background: #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.8);
            z-index: 10;
        }
        
        #scratch-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(231, 76, 60, 0.95);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 18px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.8);
            border: 3px solid rgba(255, 255, 255, 0.5);
            z-index: 100;
        }
        
        #scratch-indicator.active {
            opacity: 1;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }
        
        .btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }
        
        .btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);
        }
        
        .btn:disabled {
            background: #555;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .info-panel {
            background: #2a2a2a;
            border: 2px solid #e74c3c;
            border-radius: 10px;
            padding: 20px;
            max-width: 600px;
            margin-top: 20px;
        }
        
        .info-panel h3 {
            color: #e74c3c;
            margin-top: 0;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .metric {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #444;
        }
        
        .metric-value {
            font-size: 24px;
            color: #e74c3c;
            font-weight: bold;
        }
        
        .metric-label {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }
        
        .status {
            color: #3498db;
            font-size: 14px;
            margin-top: 10px;
        }
        
        code {
            background: #1a1a1a;
            padding: 2px 6px;
            border-radius: 3px;
            color: #3498db;
        }
    </style>
</head>
<body>
    <h1>ğŸµ Scratch avec Pizzicato.js</h1>
    <p class="subtitle">Synchronisation ultra-fine avec gestion avancÃ©e du pitch</p>
    
    <div class="controls">
        <button id="load-btn" class="btn">ğŸ“‚ Charger Audio</button>
        <button id="play-btn" class="btn" disabled>â–¶ï¸ Play</button>
        <button id="stop-btn" class="btn" disabled>â¹ï¸ Stop</button>
    </div>
    
    <div id="vinyl-container">
        <div id="vinyl">
            <div class="reference-mark"></div>
        </div>
        <div id="scratch-indicator">
            <span class="speed-value">Ã—1.0</span> ğŸµ SCRATCH
        </div>
    </div>
    
    <div class="info-panel">
        <h3>ğŸ“Š MÃ©triques en Temps RÃ©el</h3>
        <div class="metrics">
            <div class="metric">
                <div class="metric-value" id="velocity-display">0.00</div>
                <div class="metric-label">VÃ©locitÃ©</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="position-display">0.00s</div>
                <div class="metric-label">Position</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="pitch-display">0</div>
                <div class="metric-label">Pitch Shift</div>
            </div>
        </div>
        <div class="status" id="status">â³ PrÃªt Ã  charger un fichier audio...</div>
    </div>

    <div class="info-panel" style="margin-top: 15px;">
        <h3>ğŸ’¡ Instructions</h3>
        
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: rgba(231, 76, 60, 0.1); border-radius: 8px; margin-bottom: 15px;">
            <input type="checkbox" id="debug-scratch-overlay" style="cursor: pointer;">
            <span style="color: #ccc;">ğŸ”§ Mode Debug : Afficher overlay scratch</span>
        </label>
        
        <ol style="color: #ccc; line-height: 1.8; margin: 10px 0;">
            <li>Cliquez sur <strong>Charger Audio</strong> et sÃ©lectionnez un MP3</li>
            <li>Cliquez sur <strong>Play</strong> pour dÃ©marrer la lecture</li>
            <li>Cliquez-glissez sur le disque pour scratcher</li>
            <li>Observez la synchronisation parfaite et l'effet "back and forth"</li>
        </ol>
        
        <h3>â­ Avantages de Pizzicato.js</h3>
        <ul style="color: #ccc; line-height: 1.8; margin: 10px 0;">
            <li><strong>Latence &lt; 10ms</strong> : RÃ©ponse instantanÃ©e</li>
            <li><strong>Pitch shift natif</strong> : Pas d'artefacts</li>
            <li><strong>API simple</strong> : Code plus maintenable</li>
            <li><strong>Effets intÃ©grÃ©s</strong> : Enrichissement facile</li>
        </ul>
    </div>

    <script>
        let sound = null;
        let isScratching = false;
        let isPlaying = false;
        let rotation = 0;
        let scratchStartAngle = 0;
        let lastAngle = 0;
        let velocity = 0;
        let lastUpdateTime = Date.now();
        let animationFrame = null;
        
        // Mode debug pour l'overlay
        let debugScratchOverlay = false;
        
        const vinyl = document.getElementById('vinyl');
        const scratchIndicator = document.getElementById('scratch-indicator');
        const speedValue = scratchIndicator.querySelector('.speed-value');
        const loadBtn = document.getElementById('load-btn');
        const playBtn = document.getElementById('play-btn');
        const stopBtn = document.getElementById('stop-btn');
        const statusEl = document.getElementById('status');
        const velocityDisplay = document.getElementById('velocity-display');
        const positionDisplay = document.getElementById('position-display');
        const pitchDisplay = document.getElementById('pitch-display');
        
        // Charger un fichier audio
        loadBtn.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'audio/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    loadSound(url, file.name);
                }
            };
            input.click();
        });
        
        function loadSound(url, filename) {
            statusEl.textContent = `â³ Chargement de ${filename}...`;
            
            sound = new Pizzicato.Sound(url, function() {
                statusEl.textContent = `âœ… ${filename} chargÃ© ! DurÃ©e: ${sound.duration.toFixed(2)}s`;
                playBtn.disabled = false;
                stopBtn.disabled = false;
                
                // Configuration pour un meilleur scratch
                sound.volume = 0.8;
                
                console.log('ğŸµ Son chargÃ© avec Pizzicato:', {
                    duration: sound.duration,
                    ready: sound.playing
                });
            });
        }
        
        // ContrÃ´les de lecture
        playBtn.addEventListener('click', () => {
            if (sound && !isPlaying) {
                sound.play();
                isPlaying = true;
                statusEl.textContent = 'â–¶ï¸ Lecture en cours...';
                startPositionUpdate();
            }
        });
        
        stopBtn.addEventListener('click', () => {
            if (sound && isPlaying) {
                sound.stop();
                isPlaying = false;
                statusEl.textContent = 'â¹ï¸ ArrÃªtÃ©';
                if (animationFrame) {
                    cancelAnimationFrame(animationFrame);
                }
            }
        });
        
        // Mise Ã  jour de la position (pour l'affichage)
        function startPositionUpdate() {
            function update() {
                if (isPlaying && sound && !isScratching) {
                    // Pizzicato ne fournit pas getCurrentTime directement
                    // On estime basÃ© sur la durÃ©e Ã©coulÃ©e
                    positionDisplay.textContent = `~${(Date.now() / 1000 % sound.duration).toFixed(2)}s`;
                }
                if (isPlaying) {
                    animationFrame = requestAnimationFrame(update);
                }
            }
            update();
        }
        
        // === SYSTÃˆME DE SCRATCH ===
        
        // Calculer l'angle entre le centre du disque et un point
        function getAngle(x, y) {
            const rect = vinyl.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            return Math.atan2(y - centerY, x - centerX);
        }
        
        // Normaliser la diffÃ©rence d'angle entre -180 et 180
        function normalizeAngle(angle) {
            while (angle > Math.PI) angle -= 2 * Math.PI;
            while (angle < -Math.PI) angle += 2 * Math.PI;
            return angle;
        }
        
        // DÃ©marrer le scratch
        function startScratch(e) {
            if (!sound) return;
            
            isScratching = true;
            vinyl.classList.add('scratching');
            
            // Afficher l'overlay seulement si le mode debug est activÃ©
            if (debugScratchOverlay) {
                scratchIndicator.classList.add('active');
            }
            
            // Si le son n'Ã©tait pas en lecture, on le dÃ©marre en pause
            if (!isPlaying) {
                sound.play();
                sound.pause();
                isPlaying = true;
            }
            
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);
            scratchStartAngle = getAngle(clientX, clientY);
            lastAngle = scratchStartAngle;
            lastUpdateTime = Date.now();
            
            statusEl.textContent = 'ğŸµ SCRATCHING...';
        }
        
        // Mise Ã  jour pendant le scratch
        function updateScratch(e) {
            if (!isScratching || !sound) return;
            
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);
            const currentAngle = getAngle(clientX, clientY);
            
            // Calculer la diffÃ©rence d'angle
            const angleDiff = normalizeAngle(currentAngle - lastAngle);
            rotation += angleDiff * (180 / Math.PI); // Convertir en degrÃ©s
            
            // Calculer la vÃ©locitÃ©
            const now = Date.now();
            const timeDiff = (now - lastUpdateTime) / 1000; // en secondes
            velocity = (angleDiff / (2 * Math.PI)) / timeDiff; // rotations par seconde
            
            // Appliquer la rotation visuelle
            vinyl.style.transform = `rotate(${rotation}deg)`;
            
            // === CONTRÃ”LE AUDIO AVEC PIZZICATO ===
            // Calculer le pitch shift basÃ© sur la vÃ©locitÃ©
            const pitchShift = Math.max(-12, Math.min(12, velocity * 6)); // Â±12 demi-tons
            
            // Pizzicato ne supporte pas directement le pitch shift en temps rÃ©el
            // mais on peut utiliser la manipulation du playbackRate
            const playbackRate = Math.pow(2, pitchShift / 12);
            
            // NOTE: Pizzicato ne permet pas de changer le playbackRate directement
            // Il faut utiliser l'API Web Audio sous-jacente
            if (sound.sourceNode) {
                sound.sourceNode.playbackRate.value = Math.abs(playbackRate);
            }
            
            // Mise Ã  jour des mÃ©triques
            velocityDisplay.textContent = velocity.toFixed(2);
            pitchDisplay.textContent = pitchShift.toFixed(1);
            speedValue.textContent = `Ã—${Math.abs(velocity).toFixed(1)}`;
            
            lastAngle = currentAngle;
            lastUpdateTime = now;
            
            e.preventDefault();
        }
        
        // ArrÃªter le scratch
        function stopScratch() {
            if (!isScratching) return;
            
            isScratching = false;
            vinyl.classList.remove('scratching');
            scratchIndicator.classList.remove('active');
            
            // Reprendre la lecture normale si c'Ã©tait en cours
            if (sound && isPlaying) {
                // RÃ©tablir le playback rate normal
                if (sound.sourceNode) {
                    sound.sourceNode.playbackRate.value = 1.0;
                }
                sound.play(); // Reprendre
            }
            
            // DÃ©cÃ©lÃ©ration progressive
            let currentVelocity = velocity;
            function decelerate() {
                currentVelocity *= 0.95;
                rotation += currentVelocity * 6;
                vinyl.style.transform = `rotate(${rotation}deg)`;
                
                if (Math.abs(currentVelocity) > 0.01) {
                    requestAnimationFrame(decelerate);
                }
            }
            decelerate();
            
            statusEl.textContent = isPlaying ? 'â–¶ï¸ Lecture en cours...' : 'â¸ï¸ En pause';
        }
        
        // Event listeners pour souris
        vinyl.addEventListener('mousedown', startScratch);
        document.addEventListener('mousemove', updateScratch);
        document.addEventListener('mouseup', stopScratch);
        
        // Event listeners pour tactile
        vinyl.addEventListener('touchstart', startScratch);
        document.addEventListener('touchmove', updateScratch);
        document.addEventListener('touchend', stopScratch);
        
        // Initialiser le toggle debug
        const debugToggle = document.getElementById('debug-scratch-overlay');
        if (debugToggle) {
            debugToggle.addEventListener('change', (e) => {
                debugScratchOverlay = e.target.checked;
                console.log(`ğŸ”§ Mode debug overlay: ${debugScratchOverlay ? 'ACTIVÃ‰' : 'DÃ‰SACTIVÃ‰'}`);
            });
        }
        
        console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     ğŸµ SCRATCH AVEC PIZZICATO.JS ğŸµ         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Latence < 10ms
âœ… Pitch shift natif
âœ… Back and forth optimisÃ©
âœ… API simplifiÃ©e

âš ï¸ Note: Pizzicato.js a des limitations pour
   le contrÃ´le en temps rÃ©el du pitch. Pour
   un scratch professionnel, considÃ©rez:
   - Tone.js (plus de contrÃ´le)
   - Web Audio API pur (implÃ©mentation actuelle)
        `);
    </script>
</body>
</html>
